name: Close Related Issue on PR Close

on:
  pull_request:
    types: [closed]

jobs:
  close_related_issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Extract issue number from PR body
        id: extract_issue
        run: |
          # PRã®æœ¬æ–‡ã‚’å–å¾—
          pr_body="${{ github.event.pull_request.body }}"
          echo "PR Body: $pr_body"
          
          # "Closes #123" ã‚„ "Fixes #123" ãªã©ã®å½¢å¼ã§Issueç•ªå·ã‚’æŠ½å‡º
          # è¤‡æ•°ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾å¿œ
          issue_number=$(echo "$pr_body" | grep -oiE "(close[sd]?|fix(e[sd])?|resolve[sd]?) #([0-9]+)" | grep -oE "#[0-9]+" | head -1 | sed 's/#//')
          
          if [ -z "$issue_number" ]; then
            echo "No issue reference found in PR body"
            echo "issue_found=false" >> $GITHUB_OUTPUT
          else
            echo "Found issue number: $issue_number"
            echo "issue_found=true" >> $GITHUB_OUTPUT
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          fi

      - name: Close related issue
        if: steps.extract_issue.outputs.issue_found == 'true'
        run: |
          issue_number="${{ steps.extract_issue.outputs.issue_number }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_merged="${{ github.event.pull_request.merged }}"
          
          # PRã®çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¯ãƒ­ãƒ¼ã‚ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ±ºå®š
          if [ "$pr_merged" = "true" ]; then
            close_reason="completed"
            comment_body="ğŸ‰ ã“ã®Issueã¯é–¢é€£ã™ã‚‹PR #${pr_number} ãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸãŸã‚è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚"
          else
            close_reason="not_planned"
            comment_body="âŒ ã“ã®Issueã¯é–¢é€£ã™ã‚‹PR #${pr_number} ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸãŸã‚è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚"
          fi
          
          # Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/${issue_number}/comments \
            -f body="$comment_body"
          
          # Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/${issue_number} \
            -f state="closed" \
            -f state_reason="$close_reason"
          
          echo "âœ… Issue #${issue_number} has been closed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log completion
        run: |
          if [ "${{ steps.extract_issue.outputs.issue_found }}" = "true" ]; then
            echo "âœ… Successfully processed PR close and closed related issue #${{ steps.extract_issue.outputs.issue_number }}"
          else
            echo "â„¹ï¸ No related issue found to close"
          fi
