name: Close Related Issue on PR Close

on:
  pull_request:
    types: [closed]

jobs:
  close_related_issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Extract issue number from PR body
        id: extract_issue
        run: |
          # PRの本文を取得
          pr_body="${{ github.event.pull_request.body }}"
          echo "PR Body: $pr_body"
          
          # "Closes #123" や "Fixes #123" などの形式でIssue番号を抽出
          # 複数のキーワードに対応
          issue_number=$(echo "$pr_body" | grep -oiE "(close[sd]?|fix(e[sd])?|resolve[sd]?) #([0-9]+)" | grep -oE "#[0-9]+" | head -1 | sed 's/#//')
          
          if [ -z "$issue_number" ]; then
            echo "No issue reference found in PR body"
            echo "issue_found=false" >> $GITHUB_OUTPUT
          else
            echo "Found issue number: $issue_number"
            echo "issue_found=true" >> $GITHUB_OUTPUT
            echo "issue_number=$issue_number" >> $GITHUB_OUTPUT
          fi

      - name: Close related issue
        if: steps.extract_issue.outputs.issue_found == 'true'
        run: |
          issue_number="${{ steps.extract_issue.outputs.issue_number }}"
          pr_number="${{ github.event.pull_request.number }}"
          pr_merged="${{ github.event.pull_request.merged }}"
          
          # PRの状態に応じてクローズメッセージを決定
          if [ "$pr_merged" = "true" ]; then
            close_reason="completed"
            comment_body="🎉 このIssueは関連するPR #${pr_number} がマージされたため自動的にクローズされました。"
          else
            close_reason="not_planned"
            comment_body="❌ このIssueは関連するPR #${pr_number} がクローズされたため自動的にクローズされました。"
          fi
          
          # Issueにコメントを追加
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/${issue_number}/comments \
            -f body="$comment_body"
          
          # Issueをクローズ
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/${issue_number} \
            -f state="closed" \
            -f state_reason="$close_reason"
          
          echo "✅ Issue #${issue_number} has been closed"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log completion
        run: |
          if [ "${{ steps.extract_issue.outputs.issue_found }}" = "true" ]; then
            echo "✅ Successfully processed PR close and closed related issue #${{ steps.extract_issue.outputs.issue_number }}"
          else
            echo "ℹ️ No related issue found to close"
          fi
