name: Close Related Issue on PR Close

on:
  pull_request:
    types: [closed]

jobs:
  close_related_issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Extract issue number from PR body
        id: extract_issue
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            console.log('Processing PR body for issue references...');
            
            // å„ç¨®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œã—ãŸæ­£è¦è¡¨ç¾
            const patterns = [
              /closes\s+#(\d+)/i,
              /close\s+#(\d+)/i,
              /closed\s+#(\d+)/i,
              /fixes\s+#(\d+)/i,
              /fix\s+#(\d+)/i,
              /fixed\s+#(\d+)/i,
              /resolves\s+#(\d+)/i,
              /resolve\s+#(\d+)/i,
              /resolved\s+#(\d+)/i
            ];
            
            let issueNumber = null;
            
            // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
            for (const pattern of patterns) {
              const match = prBody.match(pattern);
              if (match) {
                issueNumber = match[1];
                console.log(`Found issue reference: ${match[0]} -> Issue #${issueNumber}`);
                break;
              }
            }
            
            if (issueNumber) {
              core.setOutput('issue_found', 'true');
              core.setOutput('issue_number', issueNumber);
              console.log(`âœ… Issue #${issueNumber} will be closed when PR is processed`);
            } else {
              core.setOutput('issue_found', 'false');
              console.log('â„¹ï¸ No issue reference found in PR body');
            }
            
            return {
              found: !!issueNumber,
              number: issueNumber
            };

      - name: Close related issue
        if: steps.extract_issue.outputs.issue_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract_issue.outputs.issue_number }};
            const prNumber = context.payload.pull_request.number;
            const prMerged = context.payload.pull_request.merged;
            const { owner, repo } = context.repo;
            
            console.log(`Processing issue closure for Issue #${issueNumber} related to PR #${prNumber}`);
            console.log(`PR merged status: ${prMerged}`);
            
            // PRã®çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¯ãƒ­ãƒ¼ã‚ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ±ºå®š
            let closeReason, commentBody;
            if (prMerged) {
              closeReason = 'completed';
              commentBody = `ğŸ‰ ã“ã®Issueã¯é–¢é€£ã™ã‚‹PR #${prNumber} ãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸãŸã‚è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚`;
            } else {
              closeReason = 'not_planned';
              commentBody = `âŒ ã“ã®Issueã¯é–¢é€£ã™ã‚‹PR #${prNumber} ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸãŸã‚è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã—ãŸã€‚`;
            }
            
            try {
              // Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: commentBody
              });
              
              console.log(`âœ… Comment added to Issue #${issueNumber}`);
              
              // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
              await github.rest.issues.update({
                owner,
                repo,
                issue_number: issueNumber,
                state: 'closed',
                state_reason: closeReason
              });
              
              console.log(`âœ… Issue #${issueNumber} has been closed with reason: ${closeReason}`);
              
              return {
                success: true,
                issue_number: issueNumber,
                action: prMerged ? 'merged_and_closed' : 'closed',
                comment_added: true
              };
              
            } catch (error) {
              console.error(`âŒ Error processing Issue #${issueNumber}:`, error);
              throw error;
            }

      - name: Log completion
        run: |
          if [ "${{ steps.extract_issue.outputs.issue_found }}" = "true" ]; then
            echo "âœ… Successfully processed PR close and closed related issue #${{ steps.extract_issue.outputs.issue_number }}"
          else
            echo "â„¹ï¸ No related issue found to close"
          fi
